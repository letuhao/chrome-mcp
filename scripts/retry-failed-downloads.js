/**
 * Utility script to retry failed downloads from a saved report
 * 
 * Usage: Load a report JSON file and retry all failed downloads
 * 
 * This script reads a report file generated by batch_download_torrents
 * and retries only the failed items.
 */

const fs = require('fs');
const path = require('path');

async function retryFailedDownloads(reportPath, maxRetries = 3) {
  try {
    // Read the report file
    const reportContent = fs.readFileSync(reportPath, 'utf-8');
    const report = JSON.parse(reportContent);
    
    // Filter failed items
    const failedItems = report.items.filter((item: any) => !item.success);
    
    if (failedItems.length === 0) {
      console.log('No failed downloads to retry!');
      return { success: true, message: 'No failed downloads found' };
    }
    
    console.log(`Found ${failedItems.length} failed downloads to retry`);
    
    // Extract URLs from failed items
    const failedUrls = failedItems.map((item: any) => item.tab?.url || item.preReport?.pageUrl).filter(Boolean);
    
    return {
      success: true,
      failedCount: failedItems.length,
      failedUrls: failedUrls,
      failedItems: failedItems.map((item: any) => ({
        url: item.tab?.url || item.preReport?.pageUrl,
        error: item.error,
        retryCount: item.retryCount || 0,
        downloadUrl: item.downloadUrl,
        selectedTorrent: item.selectedTorrent,
      })),
      message: `Found ${failedItems.length} failed downloads. Use these URLs with batch_download_torrents tool.`,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : String(error),
    };
  }
}

// Export for use in Node.js or return result if run directly
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { retryFailedDownloads };
} else {
  // If run directly, return the function
  return retryFailedDownloads;
}

